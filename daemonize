#!/usr/bin/env bash

# TODO: Set the following variables first.
name=rtsports-scoresyncer
basedir=/opt/sports/scoresyncer

program=$0
logdir=${basedir}/logs
rundir=${basedir}/run
pidfile=${rundir}/${name}.pid

daemon_extra_options=


usage()
{
  cat <<USAGE
  ${program} [start (development|integration|production)|stop|restart|status]
  ${program} help
USAGE
  exit ${1:-1}
}

prepare_dirs()
{
  for dir in $basedir $logdir $rundir; do
    if [ ! -d $dir ]; then
      echo "Creating dir: $dir ..."
      mkdir -p $dir
    fi
  done
}

post_action()
{
    :
}

set_vars_by_mode()
{
  runmode="./runmode.conf"

  # should set `binary` according to mode
  if [ ! -f $runmode ]; then
    echo "Config file missing: $runmode"
    exit 1
  fi

  echo "Changing [$runmode] current user ready-only.."
  chmod 0600 $runmode >/dev/null 2>&1
  if [ ! $? ]; then
    sudo chmod 0600 $runmode >/dev/null 2>&1
  fi

  source $runmode

  if [ "x$binary" = "x" ]; then
    echo "Variable not set: binary"
    exit 11
  fi

  binarywrapper
}


# Utility functions that can be used in runmode.conf
get_lan_ip()
{
    ip addr | grep 'state UP' -A2 | grep '192.168' | awk '{print $2}' | cut -f1 -d'/'
}

binarywrapper()
{
  script_name="./${name}-wrapper"

  cat << EOF > $script_name
#!/usr/bin/env bash
## DO NOT EDIT
# Autogenerated by daemonize according to current mode
$binary &
trap "kill -TERM \$!" TERM USR1
wait \$!
EOF
  chmod 0700 $script_name

  binary=$script_name
}


## main

cd $(dirname $0)
cwd=$(pwd)

if [ $# -lt 1 ]; then
  usage 1
fi

daemon=$(test -x /usr/local/bin/daemon && echo /usr/local/bin/daemon || echo /usr/bin/daemon)

prepare_dirs

if [ $1 == "start" ]; then
  mode=$2

  if [[ ( "x$mode" != "xdevelopment" ) && ( "x$mode" != "xintegration" )
    && ( "x$mode" != "xproduction" ) ]];
  then
    echo "${program} start (development|integration|production)"
    exit 1
  fi

  set_vars_by_mode

  $daemon --name=${name} --pidfile ${pidfile} --respawn \
    --errlog=${logdir}/${name}-daemon-error.log \
    --dbglog=${logdir}/${name}-daemon-debug.log \
    --output=${logdir}/${name}-error.log \
    -D${cwd} -v ${daemon_extra_options} -- ${binary}

  exit $?

elif [ $1 == "stop" ]; then
  $daemon --name=${name} --pidfile ${pidfile} --stop
  exit $?

elif [ $1 == "restart" ]; then
  $daemon --name=${name} --pidfile ${pidfile} --restart
  exit $?

elif [ $1 == "status" ]; then
  $daemon --name=${name} --pidfile ${pidfile} --running
  if [ $? -eq 0 ]; then
    echo "Running..."
  else
    echo "Not running..."
  fi

  exit 0

elif [ $1 == "help" ]; then
  usage 0

else
  usage 1
fi

